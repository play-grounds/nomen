<!DOCTYPE html>
<html>
  <head></head>
  <body>
    <script type="module">
      import Navbar from './components/NavbarLogin.js'
      import Sidebar from './components/Sidebar.js'
      import { html, render, Component } from './js/standalone.module.js'
      import sha256 from 'https://cdn.skypack.dev/sha256'
      import ripemd160 from 'https://cdn.skypack.dev/ripemd160-min'

      class App extends Component {
        constructor(props) {
          super(props)
          this.state = {
            name: '',
            pubkey: '',
            opReturn: 'NOM'
          }
          this.handleNameChange = this.handleNameChange.bind(this)
          this.handlePubkeyChange = this.handlePubkeyChange.bind(this)
          this.handleGetPubkeyFromExtension =
            this.handleGetPubkeyFromExtension.bind(this)
        }

        async handleGetPubkeyFromExtension() {
          try {
            const pubkey = await window.nostr.getPublicKey()
            this.setState({
              pubkey: pubkey,
              opReturn: 'NOM' + this.state.name + pubkey
            })
          } catch (error) {
            console.error('Error retrieving pubkey:', error)
          }
        }

        async handleNameChange(event) {
          const value = event.target.value
          const h5 = await sha256(value)
          this.setState({
            name: value,
            opReturn: 'NOM' + this.state.name + this.state.pubkey,
            h5: h5
          })
        }

        async handlePubkeyChange(event) {
          const value = event.target.value
          this.setState({
            pubkey: value,
            opReturn: 'NOM' + this.state.name + value
          })
        }

        render() {
          // var name5 = await sha256(this.state.name)
          // console.log(name5)

          var hash5 = this.state.h5

          // console.log('sha2', hash5?.toString('hex'))
          if (!hash5) {
            hash5 = ''
          }
          function hexToBytes(hex) {
            let bytes = []
            for (let i = 0; i < hex.length; i += 2) {
              bytes.push(parseInt(hex.substr(i, 2), 16))
            }
            return new Uint8Array(bytes)
          }
          hash5 = new ripemd160().update(hexToBytes(hash5)).digest('hex')
          // console.log(hash5)
          hash5 = hash5.slice(0, 5).toString('hex')
          // console.log(hash5)

          var hash20 = sha256(this.state.pubkey + this.state.name)
          hash20 = new ripemd160().update(hexToBytes(hash20)).digest('hex')
          hash20 = hash20.slice(0, 20).toString('hex')

          return html`
            <div style="margin-left: 215px; margin-top: 15px;">
              <form style="">
                <label for="nameInput">Name:</label>
                <br />
                <input
                  id="nameInput"
                  type="text"
                  placeholder="Enter your name here"
                  value="${this.state.name}"
                  onKeyUp="${this.handleNameChange}"
                />
                <br />
                <label for="pubkeyInput">Pubkey:</label>
                <br />
                <input
                  id="pubkeyInput"
                  type="text"
                  placeholder="Enter your pubkey here"
                  value="${this.state.pubkey}"
                  onKeyUp="${this.handlePubkeyChange}"
                />
                <button
                  type="button"
                  onClick="${this.handleGetPubkeyFromExtension}"
                >
                  get from extension
                </button>
                <br />
                <br />
                <label for="opReturnOutput">OP_RETURN</label>
                <br />
                <br />
                NOM
                <br />
                ${this.state.name}
                <br />
                ${this.state.pubkey}
                <br />
                5 chars : ripe160(sha256(name))
                <br />
                ${hash5}
                <br />
                20 chars : ripe160(sha256(pubkey + name))
                <br />
                ${hash20}
              </form>
            </div>
          `
        }
      }

      render(
        html`
          <${Navbar}
            links=${[
              {
                '@id':
                  'https://github.com/ursuscamp/nomen/blob/master/docs/SPEC.md',
                label: 'Nomen'
              },
              {
                '@id': 'https://nomenexplorer.com/explorer',
                label: 'Explorer'
              },
              {
                '@id': 'https://nomenexplorer.com/stats',
                label: 'Stats'
              },
              {
                '@id': 'https://nomenexplorer.com/newname',
                label: 'Create'
              },
              {
                '@id': 'https://nomenexplorer.com/api/name',
                label: 'API'
              }
            ]}
          />
          <${Sidebar} />

          <${App} />
        `,
        document.body
      )
    </script>
  </body>
</html>
